<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>6</epicId>
    <storyId>6.4</storyId>
    <title>Content Draft AI Generator Endpoint</title>
    <status>drafted</status>
    <generatedAt>2025-11-25T23:01:47+01:00</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/6-4-content-draft-ai-generator-endpoint.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>campaign manager</asA>
    <iWant>an AI endpoint that generates content drafts for a specific slot</iWant>
    <soThat>I can quickly create copy variants without manual writing</soThat>
    <tasks>
- [ ] Task 1: Create AI prompt for content draft generation (AC: 1, 2)
  - [ ] Create `lib/ai/prompts/content-draft-generator.ts`
  - [ ] Design prompt to generate copy based on slot context
  - [ ] Include slot metadata in prompt (segments, topics, goals, angle, CTA, funnel_stage, objective, content_type, channel)
  - [ ] Include message strategy if available (segment × topic combination)
  - [ ] Add guidance for hook generation (1-2 sentences, attention-grabbing)
  - [ ] Add guidance for body generation (main text, engaging, min 50 chars)
  - [ ] Add guidance for CTA copy generation (based on cta_type)
  - [ ] Add guidance for visual idea generation (2-5 sentences, descriptive)
  - [ ] Add guidance for alt text suggestion (accessibility)
  - [ ] Add guidance for length hint (based on content_type)
  - [ ] Add guidance for tone notes (if tone_override present)
  - [ ] Support multiple variants (1-3) with slight variations

- [ ] Task 2: Create AI endpoint (AC: 1-6)
  - [ ] Create `app/api/ai/content-slots/[slotId]/drafts/route.ts`
  - [ ] Implement POST handler
  - [ ] Validate slot exists (query content_slots table)
  - [ ] Validate slot has required metadata (primary_segment_id, primary_topic_id, funnel_stage, etc.)
  - [ ] Parse request body: `{ variant_count?: number, tone_preference?: string }`
  - [ ] Validate variant_count (1-3, default: 1)
  - [ ] Load slot data with relationships (segments, topics, goals, message strategy)
  - [ ] Call AI provider with content draft generator prompt
  - [ ] Stream response with progress updates
  - [ ] Parse AI response into ContentDraft objects
  - [ ] Validate drafts against ContentDraftSchema
  - [ ] Save drafts to database (content_drafts table)
  - [ ] Return saved drafts: `{ drafts: ContentDraft[] }`
  - [ ] Add error handling (404 for slot not found, 400 for validation, 500 for server errors)

- [ ] Task 3: Implement streaming response (AC: 4)
  - [ ] Use streaming response pattern from Story 5.2 or 5.8
  - [ ] Stream progress: "Generating draft 1 of 2..."
  - [ ] Stream draft preview as it's generated
  - [ ] Stream completion: "Draft 1 generated successfully"
  - [ ] Final response: `{ drafts: ContentDraft[] }`

- [ ] Task 4: Load slot context including message strategy (AC: 2)
  - [ ] Query slot with all relationships:
    - Primary segment (with demographics, psychographics, media habits)
    - Secondary segments (if any)
    - Primary topic (with core narrative, content angles)
    - Secondary topics (if any)
    - Related goals (with descriptions, target metrics)
    - **Message strategy (CRITICAL):** Query `message_strategies` table for primary_segment_id × primary_topic_id combination
      - If strategy exists, load full strategy (strategy_core, style_tone, cta_funnel, extra_fields)
      - If no strategy for primary, try secondary segment × primary topic or primary segment × secondary topic
      - Include strategy in prompt context with clear indication it should heavily influence copy generation
  - [ ] Format context for AI prompt, emphasizing strategy importance when available

- [ ] Task 5: Test and validate (AC: 1-6)
  - [ ] Test with valid slotId and variant_count=1
  - [ ] Test with variant_count=2, 3
  - [ ] Test with tone_preference override
  - [ ] Test with slot missing required metadata (should error)
  - [ ] Test with non-existent slotId (404)
  - [ ] Test with invalid variant_count (400)
  - [ ] Verify drafts are saved to database
  - [ ] Verify drafts have correct slot_id
  - [ ] Verify drafts have created_by='ai' and status='draft'
  - [ ] Verify all required fields present (hook, body, cta_copy, visual_idea)
  - [ ] Verify min lengths (hook: 10, body: 50, cta_copy: 5, visual_idea: 20)
    </tasks>
  </story>

  <acceptanceCriteria>
1. **Given** I have a content slot with enhanced metadata
   **When** I POST to `/api/ai/content-slots/[slotId]/drafts` with `{ variant_count?: number, tone_preference?: string }`
   **Then** Endpoint generates 1-3 content draft variants (default: 1, max: 3)
   **And** Each draft includes all required fields:
   - `hook` (1-2 sentences, min 10 chars)
   - `body` (main text, min 50 chars)
   - `cta_copy` (call-to-action, min 5 chars)
   - `visual_idea` (2-5 sentences, min 20 chars)
   - `alt_text_suggestion` (if applicable)
   - `length_hint` (based on content_type, e.g., "max. 100 szó", "15s videó")
   - `tone_notes` (if tone_override present in slot)

2. **And** Drafts use slot context:
   - Primary + secondary segments (demographics, psychographics, media habits)
   - Primary + secondary topics (core narrative, content angles)
   - Related goals (goal descriptions, target metrics)
   - **Message strategy (CRITICAL - if segment × topic combination exists in message_strategies table):**
     - strategy_core (positioning_statement, core_message, supporting_messages, proof_points)
     - style_tone (tone_profile, language_style, communication_guidelines, emotional_temperature)
     - cta_funnel (funnel_stage, cta_objectives, cta_patterns, friction_reducers)
     - extra_fields (framing_type, key_phrases, risk_notes)
   - Angle type and hint from slot (which may have been informed by strategy)
   - CTA type from slot (which may have been informed by strategy)
   - Funnel stage from slot
   - Objective from slot
   - Content type from slot
   - Channel from slot

3. **And** Response format: `{ drafts: ContentDraft[] }`
   **And** All drafts have `created_by: 'ai'` and `status: 'draft'`
   **And** All drafts have `slot_id` set to the provided slotId
   **And** Optional `variant_name` can be set (e.g., "Variáns 1", "Variáns 2", "Variáns 3")

4. **And** Streaming progress shows: "Generating draft 1 of 2...", "Generating draft 2 of 2...", etc.
   **And** Streaming includes draft preview as it's generated

5. **And** Validation ensures slot exists and has required metadata
   **And** Validation ensures variant_count is between 1 and 3
   **And** Error handling for missing slot (404) or invalid variant_count (400)

6. **And** Generated drafts are saved to database automatically
   **And** Response returns saved drafts with database IDs
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/epics.md" title="Epic Breakdown" section="Epic 6: Content Slot / Content Draft Szeparáció">
        Epic 6 célja: Content Slot és Content Draft modell szeparációja két szintű architektúrára. Story 6.4: Content Draft AI Generator Endpoint - AI endpoint, amely content draft-okat generál egy adott slot alapján, 1-3 variánssal.
      </doc>
      <doc path="docs/tech-spec.md" title="Technical Specification" section="Epic 5: Execution Planner">
        Execution Planner AI endpoint minták, streaming response pattern, content slot struktúra. Story 5.8: Sprint-Specific Content Slot Generation - hasonló endpoint pattern streaming-gel.
      </doc>
      <doc path="docs/sprint-artifacts/6-1-content-slot-schema-enhancement-draft-table.md" title="Story 6.1" section="ContentDraft Schema">
        ContentDraft tábla struktúra, ContentDraftSchema definíció, kötelező mezők (hook, body, cta_copy, visual_idea), opcionális mezők (alt_text_suggestion, length_hint, tone_notes).
      </doc>
      <doc path="docs/sprint-artifacts/6-2-content-slot-planner-refactor-no-copy.md" title="Story 6.2" section="Content Slot Planner">
        Content Slot Planner AI prompt refactor, angle_type és cta_type generálás, message strategy integráció, slot metadata struktúra.
      </doc>
      <doc path="docs/sprint-artifacts/6-3-content-draft-api-crud.md" title="Story 6.3" section="Content Draft API">
        Content Draft CRUD API endpoints, ContentDraftSchema validáció, database műveletek, error handling.
      </doc>
    </docs>
    <code>
      <file path="lib/ai/prompts/content-slot-planner.ts" kind="prompt" symbol="CONTENT_SLOT_PLANNER_SYSTEM_PROMPT, CONTENT_SLOT_PLANNER_USER_PROMPT" lines="29-241" reason="Reference prompt pattern for AI content generation, includes message strategy integration, slot context handling">
        Content Slot Planner prompt mintája, amely bemutatja, hogyan kell message strategy-kat integrálni a prompt context-be, és hogyan kell slot metadata-t formázni AI generáláshoz.
      </file>
      <file path="lib/ai/schemas.ts" kind="schema" symbol="ContentDraftSchema" lines="453-471" reason="ContentDraft schema definition with all required and optional fields, validation rules">
        ContentDraftSchema definíció: hook (min 10), body (min 50), cta_copy (min 5), visual_idea (min 20), opcionális mezők (alt_text_suggestion, length_hint, tone_notes), created_by enum ('ai' | 'human'), status enum.
      </file>
      <file path="app/api/content-drafts/[draftId]/route.ts" kind="endpoint" symbol="GET, PUT, DELETE" lines="1-196" reason="Content Draft CRUD endpoint pattern, validation, error handling, database operations">
        Content Draft CRUD endpoint mintája: validáció ContentDraftSchema-val, error handling (404, 400, 500), Supabase database műveletek, updated_at timestamp kezelés.
      </file>
      <file path="app/api/ai/campaign-sprints/[sprintId]/content-slots/route.ts" kind="endpoint" symbol="POST" lines="1-310" reason="Streaming response pattern, SSE helper, progress updates, message strategy loading, AI provider usage">
        Streaming response pattern SSE-vel, progress updates ("Generating..."), message strategy betöltés message_strategies táblából, AI provider használat, JSON parsing és validáció.
      </file>
      <file path="app/api/strategies/route.ts" kind="endpoint" symbol="GET" lines="19-96" reason="Message strategy query pattern, segment × topic combination lookup">
        Message strategy lekérdezési minta: campaign_id alapján, JOIN segments és topics táblákkal, strategy_core, style_tone, cta_funnel, extra_fields mezők.
      </file>
      <file path="lib/ai/client.ts" kind="service" symbol="getAIProvider" reason="AI provider factory, unified interface for multi-provider support">
        AI provider factory, getAIProvider() függvény, multi-provider támogatás (Anthropic, OpenAI, Google, Ollama), generateText() és generateStream() metódusok.
      </file>
      <file path="lib/supabase/server.ts" kind="service" symbol="createClient" reason="Supabase server client creation for database operations">
        Supabase server client létrehozása database műveletekhez, schema('campaign_os') használata.
      </file>
    </code>
    <dependencies>
      <node>
        <package name="@anthropic-ai/sdk" version="^0.70.1"/>
        <package name="@google/generative-ai" version="^0.24.1"/>
        <package name="openai" version="^6.9.1"/>
        <package name="@supabase/supabase-js" version="^2.84.0"/>
        <package name="zod" version="^4.1.12"/>
        <package name="jsonrepair" version="^3.13.1"/>
        <package name="next" version="^16.0.3"/>
        <package name="react" version="^19.2.0"/>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>AI prompt must communicate in Hungarian (magyar nyelv) - all generated content must be in Hungarian</constraint>
    <constraint>ContentDraftSchema validation: hook min 10 chars, body min 50 chars, cta_copy min 5 chars, visual_idea min 20 chars</constraint>
    <constraint>Variant count must be between 1 and 3 (default: 1, max: 3)</constraint>
    <constraint>Message strategy lookup: primary_segment_id × primary_topic_id combination first, fallback to secondary combinations if not found</constraint>
    <constraint>Streaming response pattern: use SSE (Server-Sent Events) for progress updates, similar to Story 5.8 endpoint</constraint>
    <constraint>All drafts must have created_by='ai' and status='draft' when generated</constraint>
    <constraint>Slot validation: must exist, must have required metadata (primary_segment_id, primary_topic_id, funnel_stage, etc.)</constraint>
    <constraint>Error handling: 404 for slot not found, 400 for validation errors, 500 for server errors</constraint>
    <constraint>Database operations: use Supabase server client with schema('campaign_os')</constraint>
    <constraint>AI provider: use getAIProvider() from lib/ai/client.ts for unified interface</constraint>
    <constraint>JSON parsing: use jsonrepair for handling AI output inconsistencies</constraint>
  </constraints>

  <interfaces>
    <interface name="POST /api/ai/content-slots/[slotId]/drafts" kind="REST endpoint" signature="POST /api/ai/content-slots/:slotId/drafts
Request Body: { variant_count?: number (1-3, default: 1), tone_preference?: string }
Response: Streaming SSE with progress updates, final response: { drafts: ContentDraft[] }
Error Responses: 404 (slot not found), 400 (validation error), 500 (server error)" path="app/api/ai/content-slots/[slotId]/drafts/route.ts"/>
    <interface name="ContentDraftSchema" kind="Zod schema" signature="ContentDraftSchema = z.object({
  id?: string.uuid(),
  slot_id: string.uuid(),
  variant_name?: string,
  status: 'draft' | 'approved' | 'rejected' | 'published' (default: 'draft'),
  hook: string.min(10),
  body: string.min(50),
  cta_copy: string.min(5),
  visual_idea: string.min(20),
  alt_text_suggestion?: string,
  length_hint?: string,
  tone_notes?: string,
  used_segment_id?: string.uuid(),
  used_topic_id?: string.uuid(),
  used_goal_ids?: string.uuid[],
  created_by: 'ai' | 'human' (default: 'ai'),
  created_at?: string,
  updated_at?: string
})" path="lib/ai/schemas.ts"/>
    <interface name="getAIProvider()" kind="function" signature="getAIProvider(): AIProvider
Returns: Unified AI provider interface with generateText() and generateStream() methods
Supports: Anthropic, OpenAI, Google Gemini, Ollama (via environment variables)" path="lib/ai/client.ts"/>
    <interface name="message_strategies table query" kind="database query" signature="SELECT * FROM message_strategies 
WHERE campaign_id = :campaignId 
  AND segment_id = :segmentId 
  AND topic_id = :topicId
Returns: strategy_core (JSONB), style_tone (JSONB), cta_funnel (JSONB), extra_fields (JSONB)" path="app/api/strategies/route.ts"/>
  </interfaces>

  <tests>
    <standards>
      Testing framework: Jest (configured in jest.config.js)
      Test location: __tests__/api/ directory
      Test pattern: Unit tests for API endpoints, integration tests for database operations
      Validation: Use ContentDraftSchema for validation testing
      Error scenarios: Test 404, 400, 500 error cases
      Database: Use Supabase test client or mock Supabase responses
    </standards>
    <locations>
      <location>__tests__/api/</location>
      <location>__tests__/validation/</location>
    </locations>
    <ideas>
      <idea acId="1">Test POST /api/ai/content-slots/[slotId]/drafts with variant_count=1, 2, 3 - verify correct number of drafts generated</idea>
      <idea acId="1">Test draft field validation: hook min 10 chars, body min 50 chars, cta_copy min 5 chars, visual_idea min 20 chars</idea>
      <idea acId="2">Test message strategy integration: verify strategy is loaded when segment × topic combination exists</idea>
      <idea acId="2">Test slot context loading: primary/secondary segments, topics, goals, angle_type, cta_type, funnel_stage</idea>
      <idea acId="3">Test response format: verify { drafts: ContentDraft[] } structure, created_by='ai', status='draft', slot_id set correctly</idea>
      <idea acId="4">Test streaming response: verify SSE progress updates ("Generating draft 1 of 2..."), draft preview in stream</idea>
      <idea acId="5">Test validation: slot not found (404), invalid variant_count (400), missing required metadata (400)</idea>
      <idea acId="6">Test database operations: verify drafts are saved to content_drafts table with correct slot_id and all fields</idea>
      <idea acId="6">Test database IDs: verify returned drafts have database IDs (not just generated UUIDs)</idea>
    </ideas>
  </tests>
</story-context>

